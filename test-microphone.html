<!DOCTYPE html>
<html>
<head>
    <title>Microphone Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .mic-button {
            background: #007AFF;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .mic-button.recording {
            background: #FF3B30;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }
        .volume-indicator {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .volume-level {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #ffeb3b 75%, #ff9800 90%, #f44336 100%);
            transition: width 0.1s ease;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.ready { background: #d4edda; color: #155724; }
        .status.processing { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Microphone Test</h1>
        
        <div id="status" class="status ready">Ready to test microphone</div>
        
        <button id="micButton" class="mic-button">Start Microphone Test</button>
        
        <div class="volume-indicator">
            <div id="volumeLevel" class="volume-level"></div>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        const micButton = document.getElementById('micButton');
        const volumeLevel = document.getElementById('volumeLevel');
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        let isRecording = false;
        let micStream = null;
        let audioContext = null;
        let processor = null;

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function updateStatus(text, type = 'ready') {
            status.textContent = text;
            status.className = `status ${type}`;
        }

        micButton.addEventListener('click', () => {
            if (isRecording) {
                stopMicrophone();
            } else {
                startMicrophone();
            }
        });

        async function startMicrophone() {
            try {
                addLog('Requesting microphone access...');
                updateStatus('Requesting microphone access...', 'processing');
                
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                addLog('Microphone access granted');
                updateStatus('Microphone active - speak to see volume levels', 'processing');
                
                audioContext = new AudioContext();
                addLog(`AudioContext created with sample rate: ${audioContext.sampleRate}`);
                
                const micSource = audioContext.createMediaStreamSource(micStream);
                addLog('MediaStreamSource created');
                
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                addLog('ScriptProcessor created');
                
                processor.onaudioprocess = (e) => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    
                    let volumeSum = 0;
                    for (let i = 0; i < inputData.length; i++) {
                        volumeSum += Math.abs(inputData[i]);
                    }
                    
                    const averageVolume = volumeSum / inputData.length;
                    const volumePercent = Math.min(100, Math.round(averageVolume * 1000));
                    volumeLevel.style.width = volumePercent + '%';
                    
                    if (volumePercent > 5) {
                        addLog(`Volume detected: ${volumePercent}%`);
                    }
                };
                
                micSource.connect(processor);
                processor.connect(audioContext.destination);
                addLog('Audio nodes connected');
                
                micButton.textContent = 'Stop Microphone Test';
                micButton.classList.add('recording');
                isRecording = true;
                
            } catch (error) {
                console.error('Microphone error:', error);
                let errorMessage = 'Error accessing microphone: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Permission denied. Please allow microphone access and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No microphone found. Please connect a microphone and try again.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Microphone is already in use by another application.';
                } else {
                    errorMessage += error.message;
                }
                
                addLog(errorMessage);
                updateStatus(errorMessage, 'error');
            }
        }

        function stopMicrophone() {
            if (micStream) {
                micStream.getTracks().forEach(track => {
                    track.stop();
                    addLog('Microphone track stopped');
                });
                micStream = null;
            }
            
            if (processor) {
                processor.disconnect();
                addLog('ScriptProcessor disconnected');
                processor = null;
            }
            
            if (audioContext) {
                audioContext.close().then(() => {
                    addLog('AudioContext closed');
                }).catch(e => {
                    addLog('Error closing AudioContext: ' + e.message);
                });
                audioContext = null;
            }
            
            volumeLevel.style.width = '0%';
            micButton.textContent = 'Start Microphone Test';
            micButton.classList.remove('recording');
            isRecording = false;
            updateStatus('Microphone test stopped', 'ready');
            addLog('Microphone test stopped');
        }

        // Global error handlers
        window.addEventListener('error', (event) => {
            addLog(`Global error: ${event.message}`);
            updateStatus('An error occurred: ' + event.message, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            addLog(`Unhandled promise rejection: ${event.reason}`);
            updateStatus('Promise error: ' + event.reason, 'error');
            event.preventDefault();
        });

        addLog('Microphone test page loaded');
    </script>
</body>
</html> 