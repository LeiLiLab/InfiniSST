# InfiniSST Evaluationæ¨¡å¼å®Œæ•´è¯´æ˜

## æ¦‚è¿°
Evaluationæ¨¡å¼å·²ç»å®Œæ•´å®ç°ï¼Œä¸“é—¨ç”¨äºè®°å½•æ¯ä¸ªå­—ç¬¦çš„æ–‡æœ¬å’Œå»¶è¿Ÿï¼Œå¹¶ç”Ÿæˆç¬¦åˆsimulevalæ ‡å‡†çš„instance logæ–‡ä»¶ã€‚

## å®Œæ•´æµç¨‹

### 1. è¯„ä¼°æ¨¡å¼å¯ç”¨
- **ä½ç½®**: `serve/evaluation_framework.py` ç¬¬222è¡Œ
- **è§¦å‘**: åœ¨éŸ³é¢‘å¤„ç†å¼€å§‹æ—¶é€šè¿‡APIè°ƒç”¨å¯ç”¨
- **APIç«¯ç‚¹**: `POST /enable_evaluation_mode?session_id={session_id}`

### 2. å»¶è¿Ÿæ•°æ®æ”¶é›†

#### è¾“å…¥è®°å½•
- **ä½ç½®**: `serve/scheduler.py` ç¬¬579è¡Œ
- **è§¦å‘**: æ¯æ¬¡éŸ³é¢‘segmentæäº¤æ—¶
- **è®°å½•å†…å®¹**: éŸ³é¢‘segmentçš„æ—¶é—´æˆ³ï¼ˆä½¿ç”¨å ä½ç¬¦æ–‡æœ¬ï¼Œå› ä¸ºæ²¡æœ‰ground truthï¼‰
```python
input_text = f"[Audio segment {len(session.source)} samples]"
session.record_input(input_text, input_timestamp)
```

#### è¾“å‡ºè®°å½•
- **ä½ç½®**: `serve/scheduler.py` ç¬¬1034è¡Œ
- **è§¦å‘**: æ¯æ¬¡ç”Ÿæˆç¿»è¯‘æ–‡æœ¬æ—¶
- **è®°å½•å†…å®¹**: å®é™…çš„ç¿»è¯‘æ–‡æœ¬å’Œæ¯ä¸ªå­—ç¬¦çš„å»¶è¿Ÿ
```python
session.record_output(generated_text, output_timestamp, is_final=True)
```

### 3. å­—ç¬¦çº§å»¶è¿Ÿè®¡ç®—
- **ç±»**: `DelayTracker` in `serve/scheduler.py`
- **åŠŸèƒ½**: 
  - è®°å½•æ¯ä¸ªå­—ç¬¦çš„è¾“å…¥æ—¶é—´æˆ³
  - è®¡ç®—æ¯ä¸ªè¾“å‡ºå­—ç¬¦ç›¸å¯¹äºå¯¹åº”è¾“å…¥å­—ç¬¦çš„å»¶è¿Ÿ
  - ç”Ÿæˆsegmentçº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯

### 4. æ•°æ®å¯¼å‡º

#### æ–¹å¼1: æœåŠ¡å™¨ç«¯å¯¼å‡ºï¼ˆæ¨èï¼‰
- **APIç«¯ç‚¹**: `POST /export_session_delays?session_id={session_id}&filepath={path}`
- **æ ¼å¼**: Simulevalå…¼å®¹çš„instance.logæ ¼å¼
- **å†…å®¹**: åŒ…å«å®é™…çš„ç¿»è¯‘æ–‡æœ¬å’Œç²¾ç¡®çš„å»¶è¿Ÿæ•°æ®

#### æ–¹å¼2: è¯„ä¼°æ¡†æ¶å¯¼å‡ºï¼ˆå¤‡ç”¨ï¼‰
- **ä½ç½®**: `serve/evaluation_framework.py` ç¬¬804è¡Œ
- **è§¦å‘**: å½“æœåŠ¡å™¨ç«¯å¯¼å‡ºå¤±è´¥æ—¶
- **æ ¼å¼**: JSONæ ¼å¼ï¼ŒåŒ…å«ä¼°è®¡çš„å»¶è¿Ÿæ•°æ®

### 5. æ•°æ®æ ¼å¼

#### Simuleval Instance Logæ ¼å¼
```json
{
  "segment_id": 0,
  "src": "[Audio segment 0 samples]",
  "tgt": "å®é™…ç¿»è¯‘æ–‡æœ¬",
  "tokens": ["å®", "é™…", "ç¿»", "è¯‘", "æ–‡", "æœ¬"],
  "delays": [0.123, 0.156, 0.189, 0.223, 0.256, 0.289],
  "input_start_time": 1234567890.123,
  "output_time": 1234567890.412,
  "average_delay": 0.206
}
```

#### ç»Ÿè®¡ä¿¡æ¯æ ¼å¼
```json
{
  "stream_laal": 0.206,
  "min_delay": 0.123,
  "max_delay": 0.289,
  "median_delay": 0.195,
  "std_delay": 0.045,
  "total_characters": 6,
  "segments": 1,
  "session_id": "eval_user_000_be3a4f12"
}
```

## å…³é”®ç‰¹æ€§

### âœ… å·²å®ç°çš„åŠŸèƒ½
1. **å­—ç¬¦çº§å»¶è¿Ÿè®°å½•**: æ¯ä¸ªå­—ç¬¦éƒ½æœ‰ç²¾ç¡®çš„å»¶è¿Ÿæ—¶é—´
2. **å®é™…ç¿»è¯‘æ–‡æœ¬**: è¾“å‡ºè®°å½•åŒ…å«çœŸå®çš„ç¿»è¯‘ç»“æœ
3. **Simulevalå…¼å®¹**: è¾“å‡ºæ ¼å¼ç¬¦åˆæ ‡å‡†è¯„ä¼°å·¥å…·è¦æ±‚
4. **streamLAALè®¡ç®—**: è‡ªåŠ¨è®¡ç®—å¹³å‡å»¶è¿ŸæŒ‡æ ‡
5. **å¤šç”¨æˆ·å¹¶å‘**: æ”¯æŒåŒæ—¶è¯„ä¼°å¤šä¸ªç”¨æˆ·session
6. **APIé›†æˆ**: å®Œæ•´çš„REST APIæ”¯æŒ

### ğŸ”„ è¾“å…¥æ•°æ®å¤„ç†
- ç”±äºæ²¡æœ‰ground truthæºæ–‡æœ¬ï¼Œè¾“å…¥è®°å½•ä½¿ç”¨éŸ³é¢‘segmentå ä½ç¬¦
- è¾“å…¥æ—¶é—´æˆ³ç²¾ç¡®è®°å½•æ¯ä¸ªéŸ³é¢‘chunkçš„æ¥æ”¶æ—¶é—´
- è¾“å‡ºæ–‡æœ¬ä½¿ç”¨å®é™…çš„ç¿»è¯‘ç»“æœ

### ğŸ“Š è¯„ä¼°æŒ‡æ ‡
- **streamLAAL**: æ‰€æœ‰å­—ç¬¦å»¶è¿Ÿçš„å¹³å‡å€¼
- **å­—ç¬¦çº§ç»Ÿè®¡**: æœ€å°ã€æœ€å¤§ã€ä¸­ä½æ•°ã€æ ‡å‡†å·®
- **segmentçº§ç»Ÿè®¡**: æ¯ä¸ªç¿»è¯‘æ®µçš„å¹³å‡å»¶è¿Ÿ

## ä½¿ç”¨ç¤ºä¾‹

### 1. å¯ç”¨è¯„ä¼°æ¨¡å¼
```python
await self._enable_evaluation_mode()
```

### 2. è·å–å»¶è¿Ÿç»Ÿè®¡
```python
# è·å–åŸºæœ¬ç»Ÿè®¡
stats = session.get_delay_statistics()

# è·å–è¯¦ç»†å­—ç¬¦æ•°æ®
detailed_stats = session.get_delay_statistics(include_character_details=True)
```

### 3. å¯¼å‡ºinstance log
```python
# æœåŠ¡å™¨ç«¯å¯¼å‡º
export_path = session.export_delays("/path/to/instance.log")

# æˆ–é€šè¿‡API
POST /export_session_delays?session_id=test_session&filepath=/path/to/instance.log
```

## æµ‹è¯•è¿è¡Œ

ä½¿ç”¨evaluation frameworkè¿›è¡Œæµ‹è¯•ï¼š
```bash
cd serve
python run_evaluation.py
```

æµ‹è¯•ç»“æœå°†åŒ…å«ï¼š
- æ¯ä¸ªç”¨æˆ·çš„instance logæ–‡ä»¶
- è¯¦ç»†çš„JSONç»Ÿè®¡æŠ¥å‘Š
- äººç±»å¯è¯»çš„æ‘˜è¦æŠ¥å‘Š

## æ³¨æ„äº‹é¡¹

1. **è¯„ä¼°æ¨¡å¼å¿…é¡»åœ¨éŸ³é¢‘å¤„ç†å¼€å§‹å‰å¯ç”¨**
2. **Sessionå¿…é¡»ä¿æŒæ´»è·ƒçŠ¶æ€**ï¼ˆé€šè¿‡pingæœºåˆ¶ï¼‰
3. **è¾“å…¥æ–‡æœ¬æ˜¯å ä½ç¬¦**ï¼Œä¸»è¦å…³æ³¨å»¶è¿Ÿè®¡ç®—
4. **è¾“å‡ºæ–‡æœ¬æ˜¯å®é™…ç¿»è¯‘ç»“æœ**ï¼Œå¯ç”¨äºè´¨é‡åˆ†æ
5. **æ”¯æŒä¸­è‹±æ–‡å’Œæ„å¤§åˆ©è¯­**ç¿»è¯‘å¯¹ 