# Ray API å‡çº§è¯´æ˜

## æ¦‚è¿°

Rayç‰ˆæœ¬çš„InfiniSST APIç°å·²è¡¥å…¨äº†ä¸åŸç‰ˆAPIçš„å…¼å®¹æ€§ï¼Œç¡®ä¿å‰ç«¯å¯ä»¥æ— ç¼è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚

## ğŸš€ æ–°å¢åŠŸèƒ½

### 1. å®Œæ•´çš„APIç«¯ç‚¹å…¼å®¹
Rayç‰ˆæœ¬ç°åœ¨åŒ…å«æ‰€æœ‰åŸç‰ˆAPIçš„é‡è¦ç«¯ç‚¹ï¼š

#### åŸºç¡€åŠŸèƒ½
- âœ… `/init` - ä¼šè¯åˆå§‹åŒ–
- âœ… `/queue_status/{session_id}` - é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢
- âœ… `/wss/{session_id}` - WebSocketå®æ—¶ç¿»è¯‘
- âœ… `/health` - å¥åº·æ£€æŸ¥
- âœ… `/ping` - ä¼šè¯ä¿æ´»

#### æ–°å¢å…¼å®¹ç«¯ç‚¹
- âœ… `/download_youtube` - YouTubeè§†é¢‘ä¸‹è½½
- âœ… `/load_models` - æ¨¡å‹åŠ è½½
- âœ… `/load_model` - å•ä¸ªæ¨¡å‹åŠ è½½
- âœ… `/test_video/{filename}` - æµ‹è¯•è§†é¢‘æœåŠ¡
- âœ… `/debug/session_stats` - è°ƒè¯•ä¼šè¯ç»Ÿè®¡
- âœ… `/debug/session_history` - è°ƒè¯•ä¼šè¯å†å²
- âœ… `/enable_evaluation_mode` - å¯ç”¨è¯„ä¼°æ¨¡å¼
- âœ… `/session_delays/{session_id}` - ä¼šè¯å»¶è¿Ÿä¿¡æ¯

#### Rayä¸“ç”¨ç«¯ç‚¹
- âœ… `/ray/stats` - Rayç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
- âœ… `/ray/configure` - Rayç³»ç»Ÿé…ç½®

### 2. æ”¹è¿›çš„é™æ€æ–‡ä»¶æœåŠ¡
- ğŸ” **æ™ºèƒ½è·¯å¾„æ£€æµ‹**: è‡ªåŠ¨åœ¨å¤šä¸ªå¯èƒ½ä½ç½®æŸ¥æ‰¾é™æ€æ–‡ä»¶
- ğŸ”§ **è‡ªåŠ¨å›é€€**: å¦‚æœæ‰¾ä¸åˆ°é™æ€æ–‡ä»¶ï¼Œæä¾›åŸºç¡€HTMLé¡µé¢
- ğŸ“ **ç›®å½•è‡ªåŠ¨åˆ›å»º**: å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„

### 3. å¢å¼ºçš„é”™è¯¯å¤„ç†
- ğŸ“Š **è¯¦ç»†é”™è¯¯ä¿¡æ¯**: æä¾›æ›´è¯¦ç»†çš„é”™è¯¯æè¿°å’Œè°ƒè¯•ä¿¡æ¯
- ğŸ”„ **ä¼˜é›…é™çº§**: åœ¨éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨æ—¶æä¾›åŸºæœ¬åŠŸèƒ½
- ğŸ›¡ï¸ **å¼‚å¸¸ä¿æŠ¤**: é˜²æ­¢å•ä¸ªç«¯ç‚¹é”™è¯¯å½±å“æ•´ä¸ªæœåŠ¡

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### Rayåˆ†å¸ƒå¼ä¼˜åŠ¿
1. **è‡ªåŠ¨èµ„æºç®¡ç†**: Rayè‡ªåŠ¨ç®¡ç†GPUå’ŒCPUèµ„æº
2. **åŠ¨æ€æ‰¹å¤„ç†**: æ™ºèƒ½æ‰¹å¤„ç†è°ƒåº¦ä¼˜åŒ–æ€§èƒ½
3. **æ•…éšœæ¢å¤**: è‡ªåŠ¨å¤„ç†èŠ‚ç‚¹æ•…éšœå’Œé‡å¯
4. **è´Ÿè½½å‡è¡¡**: å¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥å¯é€‰

### æ€§èƒ½ä¼˜åŒ–
1. **å¼‚æ­¥å¤„ç†**: å…¨å¼‚æ­¥æ¶æ„æé«˜å¹¶å‘æ€§èƒ½
2. **å†…å­˜ä¼˜åŒ–**: æ›´å¥½çš„GPUå†…å­˜ç®¡ç†
3. **æ‰¹å¤„ç†ä¼˜åŒ–**: åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°å’Œè¶…æ—¶æ—¶é—´

## ğŸš¦ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨Ray APIæœåŠ¡å™¨

```bash
# ä½¿ç”¨SLURMå¯åŠ¨ï¼ˆæ¨èï¼‰
cd serve
sbatch ray_api.sh

# æˆ–ç›´æ¥å¯åŠ¨
python serve/ray_api.py --host 0.0.0.0 --port 8000
```

### 2. éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æµ‹è¯•æ‰€æœ‰APIåŠŸèƒ½
python serve/test_ray_api.py

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8000/health

# æŸ¥çœ‹Rayç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8000/ray/stats
```

### 3. å‰ç«¯è¿æ¥

å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹ï¼ŒRayç‰ˆæœ¬å®Œå…¨å…¼å®¹åŸç‰ˆAPIï¼š

```javascript
// åˆ›å»ºä¼šè¯
const response = await fetch('/init', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        agent_type: 'InfiniSST',
        language_pair: 'English -> Chinese',
        client_id: 'user_001'
    })
});

// WebSocketè¿æ¥
const ws = new WebSocket(`ws://localhost:8000/wss/${sessionId}`);
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. Ray Dashboard
è®¿é—® `http://localhost:8265` æŸ¥çœ‹ï¼š
- é›†ç¾¤çŠ¶æ€å’Œèµ„æºä½¿ç”¨
- ActorçŠ¶æ€å’Œä»»åŠ¡æ‰§è¡Œ
- æ€§èƒ½æŒ‡æ ‡å’Œæ—¥å¿—

### 2. APIè°ƒè¯•ç«¯ç‚¹
```bash
# ä¼šè¯ç»Ÿè®¡
curl http://localhost:8000/debug/session_stats

# ä¼šè¯å†å²
curl http://localhost:8000/debug/session_history

# Rayç³»ç»ŸçŠ¶æ€
curl http://localhost:8000/ray/stats
```

### 3. æ—¥å¿—æŸ¥çœ‹
```bash
# Rayé›†ç¾¤æ—¥å¿—
ray logs

# APIæœåŠ¡å™¨æ—¥å¿—
tail -f logs/ray_infinisst_api_*.log
```

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»åŸç‰ˆAPIè¿ç§»åˆ°Rayç‰ˆæœ¬

1. **é…ç½®æ›´æ–°**:
   ```bash
   # ç”ŸæˆRayé…ç½®æ–‡ä»¶
   python serve/ray_config.py --create-default --config serve/ray_config.json
   ```

2. **å¯åŠ¨è„šæœ¬æ›¿æ¢**:
   ```bash
   # åŸç‰ˆå¯åŠ¨
   # python serve/api.py
   
   # Rayç‰ˆæœ¬å¯åŠ¨
   sbatch serve/ray_api.sh
   # æˆ–
   python serve/ray_api.py
   ```

3. **å‰ç«¯ä»£ç **: æ— éœ€ä¿®æ”¹ï¼ŒAPIå®Œå…¨å…¼å®¹

### å…¼å®¹æ€§æ£€æŸ¥æ¸…å•

- âœ… æ‰€æœ‰APIç«¯ç‚¹å¯ç”¨
- âœ… WebSocketè¿æ¥æ­£å¸¸
- âœ… é™æ€æ–‡ä»¶æœåŠ¡
- âœ… YouTubeä¸‹è½½åŠŸèƒ½
- âœ… æ¨¡å‹åŠ è½½æœºåˆ¶
- âœ… è°ƒè¯•å’Œç›‘æ§ç«¯ç‚¹

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é™æ€æ–‡ä»¶æ‰¾ä¸åˆ°**
   ```bash
   # æ£€æŸ¥é™æ€æ–‡ä»¶ç›®å½•
   ls -la serve/static/
   # æˆ–ä»åŸç‰ˆå¤åˆ¶
   cp -r static serve/static
   ```

2. **Rayé›†ç¾¤å¯åŠ¨å¤±è´¥**
   ```bash
   # æ¸…ç†ç°æœ‰Rayè¿›ç¨‹
   ray stop --force
   # é‡æ–°å¯åŠ¨
   ray start --head
   ```

3. **ç«¯å£å ç”¨**
   ```bash
   # æ£€æŸ¥ç«¯å£ä½¿ç”¨
   lsof -i:8000
   lsof -i:8265
   # æ¸…ç†å ç”¨è¿›ç¨‹
   pkill -f ray_api
   ```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | åŸç‰ˆAPI | Rayç‰ˆæœ¬ |
|------|---------|---------|
| å¹¶å‘å¤„ç† | å¤šè¿›ç¨‹ | Ray Actors |
| èµ„æºç®¡ç† | æ‰‹åŠ¨ | è‡ªåŠ¨ |
| æ‰¹å¤„ç†è°ƒåº¦ | ç®€å• | æ™ºèƒ½åŠ¨æ€ |
| è´Ÿè½½å‡è¡¡ | åŸºç¡€ | å¤šç­–ç•¥ |
| æ•…éšœæ¢å¤ | æ‰‹åŠ¨ | è‡ªåŠ¨ |
| ç›‘æ§èƒ½åŠ› | æœ‰é™ | Ray Dashboard |
| å¯æ‰©å±•æ€§ | å•æœº | åˆ†å¸ƒå¼ |

## ğŸ¯ æœªæ¥è®¡åˆ’

1. **å»¶è¿Ÿè¿½è¸ªå¢å¼º**: å®Œå–„Rayç‰ˆæœ¬çš„å»¶è¿Ÿç»Ÿè®¡åŠŸèƒ½
2. **é…ç½®çƒ­æ›´æ–°**: æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°
3. **å¤šæ¨¡å‹æ”¯æŒ**: å¢å¼ºå¤šè¯­è¨€å¯¹æ¨¡å‹ç®¡ç†
4. **æ€§èƒ½ä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–æ‰¹å¤„ç†å’Œå†…å­˜ä½¿ç”¨

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹Ray Dashboard: `http://localhost:8265`
2. æ£€æŸ¥APIæ—¥å¿—: `/logs/ray_infinisst_api_*.log`
3. è¿è¡Œæµ‹è¯•è„šæœ¬: `python serve/test_ray_api.py`
4. æŸ¥çœ‹Rayæ—¥å¿—: `ray logs` 