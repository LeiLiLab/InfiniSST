# 实时语音翻译 Demo

这是一个基于FastAPI和WebSocket的实时语音翻译演示应用。

## 功能特点

- 支持InfiniSST翻译模型（StreamAtt暂时禁用）
- 支持多种语言方向（英译中、英译德、英译西）
- 可动态调整延迟倍数，平衡翻译速度和准确性
- 实时音频处理和翻译
- 基于WebSocket的低延迟通信
- 支持重置翻译状态，无需重新加载模型
- 优化的音频处理，减少开头空白段
- 自动检测并移除音频开头的静音部分
- 加载新模型时自动清理资源，防止内存泄漏
- 重置翻译后强制重新上传音频文件，确保干净的状态
- 优化的用户界面布局，翻译输出显示在音频控件下方
- 固定高度的翻译输出框，支持自动滚动显示最新内容
- 极简的控制流程：直接使用音频播放器控制翻译的开始、暂停和播放
- 支持麦克风实时输入，可直接翻译用户语音

## 安装依赖

```bash
pip install fastapi uvicorn python-multipart websockets soundfile numpy
```

## 运行服务器

```bash
cd serve
python run.py
```

服务器将在 http://localhost:8000 上启动。

## 使用方法

1. 打开浏览器访问 http://localhost:8000
2. 选择翻译模型（如InfiniSST）和语言方向（如English -> Chinese）
3. 点击"Load Model"加载模型
   - 如果已有加载的模型，系统会自动清理现有资源
   - 包括关闭WebSocket连接、释放音频资源和删除后端会话
   - 已上传的音频文件会被保留，可以继续使用相同的音频
4. 选择延迟倍数（影响翻译的响应速度和准确性）
   - 1x: 最快响应，处理960*16个样本，但准确性可能较低
   - 2x: 默认设置，处理960*16*2个样本，平衡速度和准确性
   - 3x: 更准确，处理960*16*3个样本，但响应较慢
   - 4x: 最准确，处理960*16*4个样本，但响应最慢
5. 点击"Update Latency"应用新的延迟设置（无需重新加载模型）
6. 选择音频输入方式：
   - **文件上传**：上传音频文件，然后使用音频播放器控制翻译过程
     - 点击播放按钮自动初始化翻译系统并开始播放和翻译
     - 首次点击播放时，系统会自动建立WebSocket连接并准备音频处理
     - 点击暂停按钮暂停音频和翻译处理
     - 再次点击播放按钮继续播放和翻译
   - **麦克风输入**：使用麦克风进行实时语音翻译
     - 点击"Start Microphone"按钮开始麦克风录制和实时翻译
     - 说话内容会被实时捕获并翻译
     - 点击"Stop Microphone"按钮停止麦克风录制和翻译
7. 翻译结果会实时显示在下方的输出框中
   - 翻译输出框高度固定，内容过多时可滚动
   - 自动滚动到底部，始终显示最新的翻译内容
8. 翻译过程中可随时调整延迟倍数并点击"Update Latency"应用
9. 如需停止当前翻译并重置状态，点击"Reset"（无需重新加载模型）
   - 重置后需要重新选择音频输入方式
   - 会话保持活跃，无需重新加载模型

## 技术说明

- 前端使用原生JavaScript和Web Audio API进行音频处理
- 后端使用FastAPI和WebSocket进行实时通信
- 音频数据以16kHz采样率处理
- 基础数据块大小为960*16个采样点，实际处理块大小为基础大小乘以延迟倍数
- 延迟倍数越大，一次处理的数据越多，翻译质量越高，但响应速度越慢
- 支持动态调整延迟倍数，无需重新加载模型
- 重置功能保留会话状态，允许在重置后继续使用相同的模型
- 音频处理优化：
  - 第一个数据块使用较小的缓冲区大小，加快初始响应速度
  - 使用预缓冲技术，确保音频处理管道准备就绪后再开始播放
  - 可选跳过音频开头的一小段，减少感知到的空白
  - 前后端同时实现静音检测，自动移除音频开头的静音部分（阈值为0.005）
- 资源管理：
  - 加载新模型时自动清理现有资源，包括WebSocket连接、音频上下文和后端会话
  - 重置翻译时正确清理音频资源，确保可以重新开始翻译
  - 完善的错误处理，确保资源在异常情况下也能被正确释放
  - 重置翻译后强制重新上传音频文件，避免使用旧的音频数据
  - 加载新模型时保留已上传的音频文件，提高用户体验
- 用户界面：
  - 垂直布局设计，翻译输出显示在音频控件下方，符合阅读习惯
  - 固定高度的翻译输出框，支持内容溢出时滚动
  - 自动滚动功能，确保始终显示最新的翻译内容
  - 响应式设计，适应不同屏幕尺寸
  - 支持切换音频输入方式（文件上传或麦克风输入）
- 极简的控制流程：
  - 无需额外的初始化按钮，直接使用音频播放器或麦克风控制翻译
  - 首次点击播放按钮或开始麦克风录制时自动初始化翻译系统
  - 播放音频时自动开始翻译，暂停音频时自动暂停翻译
  - 音频上下文会随播放状态自动挂起或恢复，减少资源占用
  - 状态指示器会显示当前是播放状态还是暂停状态
  - 音频结束或停止麦克风时自动完成翻译并清理资源
- 麦克风输入支持：
  - 使用WebAudio API捕获麦克风输入
  - 实时处理和重采样音频数据
  - 与文件上传共享相同的翻译后端
  - 支持随时切换输入方式
  - 资源管理确保麦克风在不使用时被正确释放 