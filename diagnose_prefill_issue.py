#!/usr/bin/env python3\n\"\"\"\nè¯Šæ–­PREFILLé‡å¤å…¥é˜Ÿé—®é¢˜\næ£€æŸ¥æ˜¯å¦å­˜åœ¨sessionçŠ¶æ€æ··ä¹±æˆ–é‡å¤prefill\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, Any, List\n\ndef diagnose_prefill_issue(server_url: str = \"https://infinisst.ngrok.app\"):\n    \"\"\"ä¸“é—¨è¯Šæ–­prefillé‡å¤é—®é¢˜\"\"\"\n    print(\"ğŸ” è¯Šæ–­PREFILLé‡å¤å…¥é˜Ÿé—®é¢˜\")\n    print(\"=\" * 60)\n    \n    try:\n        # è·å–è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯\n        response = requests.get(f\"{server_url}/diagnose\", timeout=10)\n        if response.status_code != 200:\n            print(f\"âŒ æ— æ³•è·å–è¯Šæ–­ä¿¡æ¯: {response.status_code}\")\n            return\n        \n        data = response.json()\n        queue_stats = data.get('queue_stats', {})\n        detailed_info = queue_stats.get('detailed_queue_info', {})\n        \n        print(\"ğŸ“Š **é˜Ÿåˆ—çŠ¶æ€åˆ†æ**:\")\n        for gpu_id, info in detailed_info.items():\n            prefill_count = info.get('prefill_queue_size', 0)\n            decode_count = info.get('decode_queue_size', 0)\n            language = info.get('language', 'unknown')\n            \n            print(f\"ğŸ–¥ï¸ GPU {gpu_id} ({language}):\")\n            print(f\"   PREFILLé˜Ÿåˆ—: {prefill_count} ä¸ªè¯·æ±‚\")\n            print(f\"   DECODEé˜Ÿåˆ—: {decode_count} ä¸ªè¯·æ±‚\")\n            \n            if prefill_count > 1:\n                print(f\"   ğŸš¨ **å¼‚å¸¸**: {prefill_count} ä¸ªPREFILLè¯·æ±‚ï¼æ­£å¸¸åº”è¯¥æœ€å¤š1ä¸ª\")\n            \n        # æ£€æŸ¥sessionçŠ¶æ€\n        print(\"\\nğŸ‘¥ **SessionçŠ¶æ€åˆ†æ**:\")\n        total_requests = queue_stats.get('total_requests', 0)\n        completed_requests = queue_stats.get('completed_requests', 0)\n        active_sessions = queue_stats.get('active_sessions', 0)\n        \n        print(f\"   æ€»è¯·æ±‚æ•°: {total_requests}\")\n        print(f\"   å·²å®Œæˆè¯·æ±‚: {completed_requests}\")\n        print(f\"   æ´»è·ƒSessions: {active_sessions}\")\n        \n        # æ£€æŸ¥ä¸æ´»è·ƒsession\n        inactive_sessions = queue_stats.get('inactive_sessions', [])\n        if inactive_sessions:\n            print(f\"\\nâ° **ä¸æ´»è·ƒSessions**: {len(inactive_sessions)} ä¸ª\")\n            for session in inactive_sessions[:5]:  # åªæ˜¾ç¤ºå‰5ä¸ª\n                print(f\"   - {session['session_id'][:8]}... (ç”¨æˆ·: {session['user_id']}, ä¸æ´»è·ƒ: {session['inactive_seconds']:.1f}s)\")\n                print(f\"     éŸ³é¢‘: {session['source_length']} æ ·æœ¬, ç¿»è¯‘: {session['target_segments']} æ®µ\")\n        \n        # åˆ†æå¯èƒ½çš„é—®é¢˜\n        print(\"\\nğŸ” **é—®é¢˜åˆ†æ**:\")\n        \n        total_prefill = sum(info.get('prefill_queue_size', 0) for info in detailed_info.values())\n        total_decode = sum(info.get('decode_queue_size', 0) for info in detailed_info.values())\n        \n        if total_prefill > active_sessions:\n            print(f\"   ğŸš¨ PREFILLè¯·æ±‚æ•°({total_prefill}) > æ´»è·ƒSessions({active_sessions})\")\n            print(f\"   å¯èƒ½åŸå› : å†…å­˜ä¸è¶³å¯¼è‡´PREFILLé‡è¯•, æˆ–sessionçŠ¶æ€æ··ä¹±\")\n        \n        if total_prefill == 0 and total_decode == 0 and active_sessions > 0:\n            print(f\"   ğŸš¨ æœ‰æ´»è·ƒSessions({active_sessions})ä½†é˜Ÿåˆ—ä¸ºç©º\")\n            print(f\"   å¯èƒ½åŸå› : è¯·æ±‚å¤„ç†å¡ä½, æˆ–å‰ç«¯åœæ­¢å‘é€æ•°æ®\")\n        \n        if total_prefill > 1:\n            print(f\"   ğŸš¨ å¤šä¸ªPREFILLè¯·æ±‚({total_prefill})åŒæ—¶å­˜åœ¨\")\n            print(f\"   å¯èƒ½åŸå› :\")\n            print(f\"     1. é¡µé¢æ± è€—å°½å¯¼è‡´PREFILLé‡è¯•\")\n            print(f\"     2. å¤šä¸ªç”¨æˆ·åŒæ—¶å¼€å§‹æ–°ç¿»è¯‘\")\n            print(f\"     3. SessionçŠ¶æ€ç®¡ç†é”™è¯¯\")\n            print(f\"     4. å‰ç«¯é‡å¤å‘é€åˆå§‹éŸ³é¢‘\")\n        \n        # æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ\n        print(\"\\nğŸ’¾ **å†…å­˜ä½¿ç”¨æ¨æ–­**:\")\n        if 'memory_pressure' in data:\n            memory_info = data['memory_pressure']\n            print(f\"   å†…å­˜å‹åŠ›: {memory_info}\")\n        else:\n            # æ ¹æ®é˜Ÿåˆ—çŠ¶æ€æ¨æ–­å†…å­˜ä½¿ç”¨\n            estimated_pages = total_prefill * 20 + total_decode * 5  # ç²—ç•¥ä¼°ç®—\n            print(f\"   ä¼°ç®—é¡µé¢ä½¿ç”¨: ~{estimated_pages} é¡µ\")\n            \n            if estimated_pages > 400:  # å‡è®¾æ€»é¡µé¢æ•°ä¸º576\n                print(f\"   ğŸš¨ å¯èƒ½æ¥è¿‘é¡µé¢æ± ä¸Šé™\")\n            elif estimated_pages > 200:\n                print(f\"   âš ï¸ é¡µé¢ä½¿ç”¨è¾ƒé«˜\")\n            else:\n                print(f\"   âœ… é¡µé¢ä½¿ç”¨æ­£å¸¸\")\n        \n        # å»ºè®®è§£å†³æ–¹æ¡ˆ\n        print(\"\\nğŸ’¡ **å»ºè®®è§£å†³æ–¹æ¡ˆ**:\")\n        \n        if total_prefill > 1:\n            print(\"   1. ğŸ”§ ä¿®å¤PREFILLé‡è¯•æœºåˆ¶:\")\n            print(\"       - é™åˆ¶PREFILLé‡è¯•æ¬¡æ•°ä¸º1æ¬¡\")\n            print(\"       - å¢åŠ sessionçŠ¶æ€æ£€æŸ¥ï¼Œé¿å…é‡å¤prefill\")\n            \n            print(\"   2. ğŸ§¹ æ¸…ç†é‡å¤çš„PREFILLè¯·æ±‚:\")\n            print(\"       - æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€sessionçš„é‡å¤è¯·æ±‚\")\n            print(\"       - æ¸…ç†ä¸å¿…è¦çš„é‡è¯•è¯·æ±‚\")\n            \n            print(\"   3. ğŸ’¾ ä¼˜åŒ–å†…å­˜ç®¡ç†:\")\n            print(\"       - åŠæ—¶æ¸…ç†ä¸æ´»è·ƒsession\")\n            print(\"       - å‡å°‘æ¯ä¸ªsessionçš„é¡µé¢ä½¿ç”¨\")\n        \n        return {\n            'total_prefill': total_prefill,\n            'total_decode': total_decode,\n            'active_sessions': active_sessions,\n            'has_prefill_issue': total_prefill > 1,\n            'possible_memory_issue': estimated_pages > 300\n        }\n        \n    except Exception as e:\n        print(f\"âŒ è¯Šæ–­å¤±è´¥: {e}\")\n        return None\n\nif __name__ == \"__main__\":\n    import argparse\n    \n    parser = argparse.ArgumentParser(description=\"è¯Šæ–­PREFILLé‡å¤å…¥é˜Ÿé—®é¢˜\")\n    parser.add_argument(\"--server\", default=\"https://infinisst.ngrok.app\", \n                       help=\"æœåŠ¡å™¨URL\")\n    \n    args = parser.parse_args()\n    result = diagnose_prefill_issue(args.server)\n    \n    if result:\n        if result['has_prefill_issue']:\n            print(f\"\\nğŸš¨ ç¡®è®¤å­˜åœ¨PREFILLé‡å¤é—®é¢˜: {result['total_prefill']} ä¸ªPREFILLè¯·æ±‚\")\n            exit(1)\n        else:\n            print(f\"\\nâœ… PREFILLçŠ¶æ€æ­£å¸¸\")\n            exit(0) 