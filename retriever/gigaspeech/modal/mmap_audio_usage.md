# mmap éŸ³é¢‘ç³»ç»Ÿä½¿ç”¨æŒ‡å—

è¿™ä¸ªç³»ç»Ÿå°†éŸ³é¢‘æ–‡ä»¶æ‰“åŒ…æˆå¤§çš„äºŒè¿›åˆ¶åˆ†ç‰‡ï¼Œåœ¨ Modal ä¸Šä½¿ç”¨ mmap è¿›è¡Œé›¶æ‹·è´éšæœºè¯»å–ï¼Œå¤§å¹…æå‡è®­ç»ƒæ•ˆç‡ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ‰“åŒ…éŸ³é¢‘æ–‡ä»¶

é¦–å…ˆéœ€è¦å°†åˆ†æ•£çš„å°éŸ³é¢‘æ–‡ä»¶æ‰“åŒ…æˆå¤§çš„åˆ†ç‰‡ï¼š

```bash
cd retriever/gigaspeech/modal
python pack_wavs_to_memmap.py
```

è¿™ä¼šæ‰«æä»¥ä¸‹ç›®å½•ï¼š
- `/mnt/gemini/data1/jiaxuanluo/term_chunks/POD`
- `/mnt/gemini/data1/jiaxuanluo/term_chunks/YOU`
- `/mnt/gemini/data1/jiaxuanluo/term_chunks/AUD`

è¾“å‡ºåˆ° `./mmap_shards/` ç›®å½•ï¼ŒåŒ…å«ï¼š
- `shard_00000.dat`, `shard_00001.dat`, ... (äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®)
- `shard_00000.index.npz`, `shard_00001.index.npz`, ... (ç´¢å¼•æ–‡ä»¶)

### 2. å¯åŠ¨è®­ç»ƒ

```bash
modal run modal_qwen2_audio_training.py
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹ `./mmap_shards/` ç›®å½•
2. ä¸Šä¼ åˆ†ç‰‡æ–‡ä»¶åˆ° Modal
3. åœ¨è®­ç»ƒä¸­ä½¿ç”¨ mmap æ•°æ®é›†

## ğŸ“ æ–‡ä»¶ç»“æ„

```
retriever/gigaspeech/modal/
â”œâ”€â”€ pack_wavs_to_memmap.py          # éŸ³é¢‘æ‰“åŒ…è„šæœ¬
â”œâ”€â”€ mmap_audio_reader.py            # mmap è¯»å–å™¨
â”œâ”€â”€ modal_qwen2_audio_training.py   # Modal è®­ç»ƒè„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ Qwen2_Audio_term_level_train_ddp_simplified.py  # è®­ç»ƒè„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰
â””â”€â”€ mmap_shards/                    # æ‰“åŒ…åçš„åˆ†ç‰‡ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    â”œâ”€â”€ shard_00000.dat
    â”œâ”€â”€ shard_00000.index.npz
    â”œâ”€â”€ shard_00001.dat
    â””â”€â”€ shard_00001.index.npz
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### éŸ³é¢‘æ‰“åŒ…
- **æ ¼å¼**: int16ï¼ˆèŠ‚çœç©ºé—´ï¼Œè®­ç»ƒæ—¶è½¬ float32ï¼‰
- **é‡‡æ ·ç‡**: 16kHzï¼ˆç»Ÿä¸€ï¼‰
- **åˆ†ç‰‡å¤§å°**: 2GB/ç‰‡ï¼ˆModal å‹å¥½ï¼‰
- **ç´¢å¼•**: keyï¼ˆè·¯å¾„å»åç¼€ï¼‰â†’ (offset, length)

### mmap è¯»å–
- **é›¶æ‹·è´**: ç›´æ¥ä»ç£ç›˜æ˜ å°„å†…å­˜
- **å¤šè¿›ç¨‹å®‰å…¨**: æ”¯æŒ DataLoader å¤š worker
- **å®¹é”™**: éŸ³é¢‘è¯»å–å¤±è´¥æ—¶è¿”å›é™éŸ³

### æ•°æ®é›†å…¼å®¹
- **è‡ªåŠ¨åˆ‡æ¢**: å¦‚æœå­˜åœ¨ mmap åˆ†ç‰‡åˆ™ä½¿ç”¨ï¼Œå¦åˆ™å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼
- **é€æ˜æ¥å£**: è®­ç»ƒä»£ç æ— éœ€ä¿®æ”¹

## ğŸ¯ æ€§èƒ½ä¼˜åŠ¿

| æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|------|
| **ä¼ ç»Ÿ** | ç®€å•ç›´æ¥ | å¤§é‡å°æ–‡ä»¶ I/Oï¼Œä¸Šä¼ æ…¢ |
| **mmap** | é›¶æ‹·è´ï¼Œä¸Šä¼ å¿«ï¼Œå¤šè¿›ç¨‹å‹å¥½ | éœ€è¦é¢„å¤„ç† |

## ğŸ“Š ä½¿ç”¨æµç¨‹

```mermaid
graph TD
    A[æœ¬åœ°éŸ³é¢‘æ–‡ä»¶] --> B[pack_wavs_to_memmap.py]
    B --> C[mmap_shards/*.dat + *.npz]
    C --> D[ä¸Šä¼ åˆ° Modal]
    D --> E[mmap æ•°æ®é›†]
    E --> F[DDP è®­ç»ƒ]
```

## ğŸ” è°ƒè¯•

### æµ‹è¯• mmap è¯»å–å™¨
```bash
python mmap_audio_reader.py ./mmap_shards
```

### æ£€æŸ¥åˆ†ç‰‡å†…å®¹
```python
from mmap_audio_reader import MMapAudioCollection

db = MMapAudioCollection("./mmap_shards")
print(f"Total samples: {len(db)}")
print(f"Sample keys: {list(db.k2loc.keys())[:5]}")

# æµ‹è¯•è¯»å–
wav, sr, key, rel = db.get_by_key(list(db.k2loc.keys())[0])
print(f"Audio shape: {wav.shape}, sr: {sr}")
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç£ç›˜ç©ºé—´**: æ‰“åŒ…åçš„åˆ†ç‰‡å¤§çº¦æ˜¯åŸéŸ³é¢‘æ–‡ä»¶çš„ 50%ï¼ˆint16 vs float32ï¼‰
2. **å†…å­˜ä½¿ç”¨**: mmap ä¸å ç”¨é¢å¤–å†…å­˜ï¼Œä½†éœ€è¦è¶³å¤Ÿçš„è™šæ‹Ÿåœ°å€ç©ºé—´
3. **å¹¶å‘**: æ”¯æŒå¤šè¿›ç¨‹è¯»å–ï¼Œä½†å†™å…¥æ—¶éœ€è¦ä¸²è¡Œ
4. **å…¼å®¹æ€§**: è‡ªåŠ¨å›é€€åˆ°ä¼ ç»Ÿæ•°æ®é›†ï¼Œç¡®ä¿å‘åå…¼å®¹

## ğŸš¨ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°éŸ³é¢‘æ–‡ä»¶
```
[INFO] Audio files not in mmap: 512866
```
**è§£å†³**: æ£€æŸ¥ `extract_audio_key_from_path` å‡½æ•°çš„è·¯å¾„è§£æé€»è¾‘

### é—®é¢˜ï¼šåˆ†ç‰‡æ–‡ä»¶è¿‡å¤§
**è§£å†³**: è°ƒæ•´ `pack_wavs_to_memmap.py` ä¸­çš„ `SHARD_BYTES` å‚æ•°

### é—®é¢˜ï¼šå†…å­˜æ˜ å°„å¤±è´¥
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç£ç›˜ç©ºé—´



















