#!/usr/bin/env python3\n\"\"\"\nå®æ—¶ç›‘æ§PREFILLæ¨¡å¼\nè¿½è¸ªä¸ºä»€ä¹ˆä¼šå‡ºç°é‡å¤prefillçš„é—®é¢˜\n\"\"\"\n\nimport requests\nimport time\nimport json\nfrom collections import defaultdict, deque\nfrom typing import Dict, List, Any\nfrom datetime import datetime\n\nclass PrefillMonitor:\n    \"\"\"ç›‘æ§prefillæ¨¡å¼å’Œsessionè¡Œä¸º\"\"\"\n    \n    def __init__(self, server_url: str = \"https://infinisst.ngrok.app\"):\n        self.server_url = server_url\n        self.session_history = defaultdict(list)  # session_id -> [events]\n        self.prefill_events = deque(maxlen=50)  # æœ€è¿‘50ä¸ªprefilläº‹ä»¶\n        self.session_stats = {}  # sessionç»Ÿè®¡ä¿¡æ¯\n        \n    def get_current_state(self) -> Dict[str, Any]:\n        \"\"\"è·å–å½“å‰ç³»ç»ŸçŠ¶æ€\"\"\"\n        try:\n            response = requests.get(f\"{self.server_url}/diagnose\", timeout=5)\n            if response.status_code == 200:\n                return response.json()\n        except Exception as e:\n            print(f\"âŒ è·å–çŠ¶æ€å¤±è´¥: {e}\")\n        return {}\n    \n    def analyze_prefill_pattern(self, data: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"åˆ†æprefillæ¨¡å¼\"\"\"\n        queue_stats = data.get('queue_stats', {})\n        detailed_info = queue_stats.get('detailed_queue_info', {})\n        \n        current_time = datetime.now()\n        \n        analysis = {\n            'timestamp': current_time.strftime('%H:%M:%S'),\n            'total_prefill': 0,\n            'total_decode': 0,\n            'active_sessions': queue_stats.get('active_sessions', 0),\n            'suspicious_patterns': [],\n            'session_analysis': []\n        }\n        \n        # ç»Ÿè®¡é˜Ÿåˆ—æƒ…å†µ\n        for gpu_id, info in detailed_info.items():\n            prefill_count = info.get('prefill_queue_size', 0)\n            decode_count = info.get('decode_queue_size', 0)\n            analysis['total_prefill'] += prefill_count\n            analysis['total_decode'] += decode_count\n        \n        # æ£€æµ‹å¯ç–‘æ¨¡å¼\n        if analysis['total_prefill'] > 1:\n            analysis['suspicious_patterns'].append(\n                f\"ğŸš¨ å¤šä¸ªPREFILLåŒæ—¶å­˜åœ¨ ({analysis['total_prefill']} ä¸ª)\"\n            )\n            \n            # è®°å½•prefilläº‹ä»¶\n            prefill_event = {\n                'time': current_time,\n                'count': analysis['total_prefill'],\n                'sessions': analysis['active_sessions']\n            }\n            self.prefill_events.append(prefill_event)\n        \n        if analysis['total_prefill'] > analysis['active_sessions']:\n            analysis['suspicious_patterns'].append(\n                f\"ğŸš¨ PREFILLæ•°é‡ ({analysis['total_prefill']}) > Sessionæ•°é‡ ({analysis['active_sessions']})\"\n            )\n        \n        if analysis['total_prefill'] == 0 and analysis['total_decode'] == 0 and analysis['active_sessions'] > 0:\n            analysis['suspicious_patterns'].append(\n                f\"ğŸš¨ æœ‰{analysis['active_sessions']}ä¸ªæ´»è·ƒSessionä½†é˜Ÿåˆ—ä¸ºç©º\"\n            )\n        \n        return analysis\n    \n    def detect_patterns_over_time(self) -> List[str]:\n        \"\"\"æ£€æµ‹æ—¶é—´æ¨¡å¼\"\"\"\n        patterns = []\n        \n        if len(self.prefill_events) >= 3:\n            # æ£€æŸ¥æ˜¯å¦æœ‰å¿«é€Ÿé‡å¤çš„prefill\n            recent_events = list(self.prefill_events)[-3:]\n            time_diffs = []\n            \n            for i in range(1, len(recent_events)):\n                diff = (recent_events[i]['time'] - recent_events[i-1]['time']).total_seconds()\n                time_diffs.append(diff)\n            \n            avg_interval = sum(time_diffs) / len(time_diffs)\n            \n            if avg_interval < 5:  # 5ç§’å†…é‡å¤\n                patterns.append(f\"âš ï¸ æ£€æµ‹åˆ°å¿«é€Ÿé‡å¤prefill (å¹³å‡é—´éš”: {avg_interval:.1f}s)\")\n                patterns.append(\"   å¯èƒ½åŸå› : å‰ç«¯é‡å¤å‘é€æˆ–WebSocketé‡è¿\")\n            \n            # æ£€æŸ¥prefillæ•°é‡è¶‹åŠ¿\n            counts = [event['count'] for event in recent_events]\n            if all(c > 1 for c in counts):\n                patterns.append(f\"âš ï¸ æŒç»­çš„å¤šprefillçŠ¶æ€ (æ•°é‡: {counts})\")\n                patterns.append(\"   å¯èƒ½åŸå› : å¹¶å‘ç«äº‰æˆ–sessionçŠ¶æ€ç®¡ç†é”™è¯¯\")\n        \n        return patterns\n    \n    def print_real_time_analysis(self, analysis: Dict[str, Any]):\n        \"\"\"æ‰“å°å®æ—¶åˆ†æç»“æœ\"\"\"\n        print(f\"\\nğŸ“Š [{analysis['timestamp']}] å®æ—¶ç›‘æ§:\")\n        print(f\"   é˜Ÿåˆ—çŠ¶æ€: {analysis['total_prefill']}P + {analysis['total_decode']}D\")\n        print(f\"   æ´»è·ƒSessions: {analysis['active_sessions']}\")\n        \n        if analysis['suspicious_patterns']:\n            print(\"   ğŸš¨ å¯ç–‘æ¨¡å¼:\")\n            for pattern in analysis['suspicious_patterns']:\n                print(f\"     {pattern}\")\n        else:\n            print(\"   âœ… æ­£å¸¸çŠ¶æ€\")\n        \n        # æ˜¾ç¤ºæ—¶é—´æ¨¡å¼åˆ†æ\n        time_patterns = self.detect_patterns_over_time()\n        if time_patterns:\n            print(\"   ğŸ•’ æ—¶é—´æ¨¡å¼åˆ†æ:\")\n            for pattern in time_patterns:\n                print(f\"     {pattern}\")\n    \n    def monitor_continuous(self, interval: int = 3, duration: int = 60):\n        \"\"\"æŒç»­ç›‘æ§æŒ‡å®šæ—¶é—´\"\"\"\n        print(f\"ğŸ” å¼€å§‹æŒç»­ç›‘æ§ (é—´éš”: {interval}s, æŒç»­: {duration}s)\")\n        print(\"=\" * 60)\n        \n        start_time = time.time()\n        check_count = 0\n        \n        while time.time() - start_time < duration:\n            try:\n                data = self.get_current_state()\n                if data:\n                    analysis = self.analyze_prefill_pattern(data)\n                    self.print_real_time_analysis(analysis)\n                    \n                    check_count += 1\n                    \n                    # æ¯10æ¬¡æ£€æŸ¥è¾“å‡ºä¸€æ¬¡ç»Ÿè®¡æ‘˜è¦\n                    if check_count % 10 == 0:\n                        self.print_summary()\n                \n                time.sleep(interval)\n                \n            except KeyboardInterrupt:\n                print(\"\\nâ¹ï¸ ç›‘æ§å·²åœæ­¢\")\n                break\n            except Exception as e:\n                print(f\"âŒ ç›‘æ§é”™è¯¯: {e}\")\n                time.sleep(interval)\n        \n        print(f\"\\nâœ… ç›‘æ§å®Œæˆ (å…±æ£€æŸ¥ {check_count} æ¬¡)\")\n        self.print_final_summary()\n    \n    def print_summary(self):\n        \"\"\"æ‰“å°é˜¶æ®µæ€§æ‘˜è¦\"\"\"\n        if not self.prefill_events:\n            return\n        \n        print(\"\\nğŸ“ˆ é˜¶æ®µæ€§æ‘˜è¦:\")\n        print(f\"   æ£€æµ‹åˆ° {len(self.prefill_events)} æ¬¡å¤šprefilläº‹ä»¶\")\n        \n        if len(self.prefill_events) >= 2:\n            intervals = []\n            events = list(self.prefill_events)\n            for i in range(1, len(events)):\n                interval = (events[i]['time'] - events[i-1]['time']).total_seconds()\n                intervals.append(interval)\n            \n            avg_interval = sum(intervals) / len(intervals)\n            min_interval = min(intervals)\n            print(f\"   å¹³å‡é—´éš”: {avg_interval:.1f}s, æœ€çŸ­é—´éš”: {min_interval:.1f}s\")\n    \n    def print_final_summary(self):\n        \"\"\"æ‰“å°æœ€ç»ˆæ€»ç»“\"\"\"\n        print(\"\\nğŸ“‹ ç›‘æ§æ€»ç»“:\")\n        print(\"=\" * 40)\n        \n        if not self.prefill_events:\n            print(\"âœ… æœªæ£€æµ‹åˆ°å¤šprefillé—®é¢˜\")\n            return\n        \n        print(f\"ğŸš¨ æ£€æµ‹åˆ° {len(self.prefill_events)} æ¬¡å¤šprefilläº‹ä»¶\")\n        \n        # åˆ†æé¢‘ç‡\n        events = list(self.prefill_events)\n        if len(events) >= 2:\n            total_time = (events[-1]['time'] - events[0]['time']).total_seconds()\n            frequency = len(events) / (total_time / 60)  # æ¯åˆ†é’Ÿé¢‘ç‡\n            print(f\"ğŸ“Š å¹³å‡é¢‘ç‡: {frequency:.1f} æ¬¡/åˆ†é’Ÿ\")\n        \n        # åˆ†æprefillæ•°é‡åˆ†å¸ƒ\n        counts = [event['count'] for event in events]\n        max_count = max(counts)\n        avg_count = sum(counts) / len(counts)\n        print(f\"ğŸ“Š PREFILLæ•°é‡: å¹³å‡ {avg_count:.1f}, æœ€é«˜ {max_count}\")\n        \n        # å»ºè®®\n        print(\"\\nğŸ’¡ å»ºè®®:\")\n        if len(events) > 10:\n            print(\"   1. æ£€æŸ¥å‰ç«¯æ˜¯å¦é‡å¤å‘é€åˆå§‹éŸ³é¢‘æ•°æ®\")\n            print(\"   2. æ£€æŸ¥WebSocketè¿æ¥ç¨³å®šæ€§\")\n            print(\"   3. è€ƒè™‘åœ¨å‰ç«¯æ·»åŠ å»é‡é€»è¾‘\")\n        else:\n            print(\"   1. é—®é¢˜ä¸ä¸¥é‡ï¼Œå¯èƒ½æ˜¯å¶å‘æ€§çš„\")\n            print(\"   2. ç»§ç»­è§‚å¯Ÿæ˜¯å¦æœ‰è§„å¾‹æ€§\")\n\ndef main():\n    import argparse\n    \n    parser = argparse.ArgumentParser(description=\"ç›‘æ§PREFILLé‡å¤æ¨¡å¼\")\n    parser.add_argument(\"--server\", default=\"https://infinisst.ngrok.app\", help=\"æœåŠ¡å™¨URL\")\n    parser.add_argument(\"--interval\", type=int, default=3, help=\"æ£€æŸ¥é—´éš”(ç§’)\")\n    parser.add_argument(\"--duration\", type=int, default=60, help=\"ç›‘æ§æŒç»­æ—¶é—´(ç§’)\")\n    parser.add_argument(\"--single\", action=\"store_true\", help=\"åªæ£€æŸ¥ä¸€æ¬¡\")\n    \n    args = parser.parse_args()\n    \n    monitor = PrefillMonitor(args.server)\n    \n    if args.single:\n        data = monitor.get_current_state()\n        if data:\n            analysis = monitor.analyze_prefill_pattern(data)\n            monitor.print_real_time_analysis(analysis)\n    else:\n        monitor.monitor_continuous(args.interval, args.duration)\n\nif __name__ == \"__main__\":\n    main() 